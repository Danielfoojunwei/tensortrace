name: Compliance Evidence (Full)

on:
  # Run on a schedule (nightly at 2 AM UTC)
  schedule:
    - cron: '0 2 * * *'

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      mode:
        description: 'Compliance check mode'
        required: true
        default: 'full'
        type: choice
        options:
          - smoke
          - full

jobs:
  # ==========================================================================
  # FULL COMPLIANCE EVIDENCE GENERATION
  # ==========================================================================
  compliance-full:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[all]"

    - name: Run Full Compliance Check
      env:
        PYTHONPATH: src
        TG_ENVIRONMENT: production
      run: |
        MODE=${{ github.event.inputs.mode || 'full' }}
        if [ "$MODE" = "full" ]; then
          make compliance
        else
          make compliance-smoke
        fi

    - name: Upload Compliance Evidence Pack
      uses: actions/upload-artifact@v4
      with:
        name: compliance-evidence-full-${{ github.sha }}
        path: reports/compliance/
        retention-days: 90

  # ==========================================================================
  # FULL BENCHMARK SUITE (Llama3 LoRA)
  # ==========================================================================
  bench-llama3:
    runs-on: ubuntu-latest
    needs: compliance-full

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[all]"

    - name: Run Full Llama3 Benchmark
      env:
        PYTHONPATH: src
        TG_ENVIRONMENT: production
      run: |
        make bench-llama3

    - name: Upload Benchmark Results
      uses: actions/upload-artifact@v4
      with:
        name: llama3-benchmark-${{ github.sha }}
        path: |
          reports/bench/
          reports/compliance/
          artifacts/benchmarks/
        retention-days: 90

  # ==========================================================================
  # COMPLIANCE REPORT SUMMARY
  # ==========================================================================
  report-summary:
    runs-on: ubuntu-latest
    needs: [compliance-full, bench-llama3]
    if: always()

    steps:
    - uses: actions/checkout@v4

    - name: Download Compliance Evidence
      uses: actions/download-artifact@v4
      with:
        name: compliance-evidence-full-${{ github.sha }}
        path: reports/compliance/

    - name: Generate Summary
      run: |
        echo "## Compliance Evidence Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Git SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Run Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Find and display evidence summary if available
        EVIDENCE_DIR=$(find reports/compliance -maxdepth 1 -type d | tail -1)
        if [ -f "$EVIDENCE_DIR/evidence.md" ]; then
          echo "### Evidence Report Available" >> $GITHUB_STEP_SUMMARY
          echo "Download the artifacts to view the full evidence pack." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts Produced" >> $GITHUB_STEP_SUMMARY
        echo "- \`compliance-evidence-full-${{ github.sha }}\`: Full compliance evidence pack" >> $GITHUB_STEP_SUMMARY
        echo "- \`llama3-benchmark-${{ github.sha }}\`: Benchmark results with compliance" >> $GITHUB_STEP_SUMMARY
