name: TensorGuard QA

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ==========================================================================
  # BUILD CORRECTNESS - Must pass before any other checks
  # ==========================================================================
  build-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Verify Python Syntax (compileall)
      run: |
        python -m compileall src -q
        echo "✓ All Python files compile successfully"

    - name: Install Package
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[all]"
        echo "✓ Package installs successfully"

    - name: Verify Imports
      run: |
        python -c "from tensorguard.utils.config import settings; print('✓ Config imports')"
        python -c "from tensorguard.platform.enterprise import check_entitlement; print('✓ Enterprise imports')"
        python -c "from tensorguard.crypto.pqc import Kyber768; print('✓ PQC imports')"
        echo "✓ Core module imports successful"

  # ==========================================================================
  # SECURITY GATES - Production safety validation
  # ==========================================================================
  security-gates:
    runs-on: ubuntu-latest
    needs: build-check
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[all]"
        pip install pytest

    - name: Run Production Gate Tests
      env:
        PYTHONPATH: src
        TG_ENVIRONMENT: development
      run: |
        pytest tests/security/test_production_gates.py -v --tb=short
        echo "✓ Production security gates verified"

    - name: Verify Demo Mode Default
      run: |
        python -c "
import os
# Ensure TG_DEMO_MODE not set
os.environ.pop('TG_DEMO_MODE', None)
demo = os.getenv('TG_DEMO_MODE', 'false').lower() == 'true'
assert demo == False, 'Demo mode must default to OFF'
print('✓ Demo mode defaults to OFF')
"

    - name: Verify Enterprise Fail-Closed
      env:
        TG_COMMUNITY_MODE: "true"
        TG_ENVIRONMENT: production
      run: |
        python -c "
from tensorguard.platform.enterprise import check_entitlement
result = check_entitlement('test', 'hsm_integration')
assert result == False, 'Enterprise features must be denied in community mode'
print('✓ Enterprise entitlements fail-closed')
"

  # ==========================================================================
  # LINTING - Code quality
  # ==========================================================================
  lint:
    runs-on: ubuntu-latest
    needs: build-check
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Linters
      run: |
        pip install ruff black

    - name: Run Ruff
      run: |
        ruff check src/ --select E,W,F --ignore E501
        echo "✓ Ruff linting complete"

    - name: Check Formatting (Black)
      run: |
        black --check src/ --line-length 120
        echo "✓ Black formatting check complete"

  # ==========================================================================
  # FULL TEST SUITE
  # ==========================================================================
  qa-suite:
    runs-on: ubuntu-latest
    needs: [build-check, security-gates]

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Build Frontend
      run: |
        cd frontend
        npm ci
        npm run build

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[all]"
        pip install pytest pytest-cov requests httpx coverage

    - name: Run Backend QA Suite
      env:
        PYTHONPATH: src
        TG_ENVIRONMENT: development
        TG_DEMO_MODE: "false"
      run: |
        pytest tests/ --cov=src/tensorguard --cov-report=xml -v --tb=short

    - name: Upload Report Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: qa-report
        path: coverage.xml

  # ==========================================================================
  # DOCKER BUILDS - Ensure container images build
  # ==========================================================================
  docker-builds:
    runs-on: ubuntu-latest
    needs: build-check
    steps:
    - uses: actions/checkout@v4

    - name: Build Platform Docker Image
      run: |
        docker build -f docker/platform/Dockerfile .

    - name: Build Bench Docker Image
      run: |
        docker build -f docker/bench/Dockerfile .
