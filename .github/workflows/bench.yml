name: Nightly Benchmarks

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Benchmark mode'
        required: true
        default: 'full'
        type: choice
        options:
          - smoke
          - full

env:
  PYTHON_VERSION: '3.11'

jobs:
  bench-full:
    name: Full Benchmark Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -e ".[dev,bench]"
          pip install python-multipart psutil

      - name: Create required directories
        run: |
          mkdir -p frontend/dist
          mkdir -p reports/bench
          mkdir -p reports/qa
          mkdir -p reports/value_evidence

      - name: Run test matrix
        run: |
          python scripts/qa/test_matrix.py --output-dir reports/qa/matrix

      - name: Run full benchmarks
        run: |
          MODE="${{ github.event.inputs.mode || 'full' }}"
          python scripts/bench/run_benchmarks.py --mode $MODE \
            --output-dir reports/bench/${{ github.sha }}

      - name: Build evidence pack
        run: |
          python scripts/evidence/build_value_evidence.py \
            --qa-dir reports/qa \
            --bench-dir reports/bench \
            --output-dir reports/value_evidence

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: nightly-bench-${{ github.sha }}
          path: reports/bench/

      - name: Upload evidence pack
        uses: actions/upload-artifact@v4
        with:
          name: nightly-evidence-${{ github.sha }}
          path: reports/value_evidence/

      - name: Upload test matrix results
        uses: actions/upload-artifact@v4
        with:
          name: nightly-matrix-${{ github.sha }}
          path: reports/qa/

  compare:
    name: Compare with Baseline
    runs-on: ubuntu-latest
    needs: bench-full
    steps:
      - uses: actions/checkout@v4

      - name: Download results
        uses: actions/download-artifact@v4
        with:
          name: nightly-bench-${{ github.sha }}
          path: reports/bench/

      - name: Download evidence
        uses: actions/download-artifact@v4
        with:
          name: nightly-evidence-${{ github.sha }}
          path: reports/value_evidence/

      - name: Print summary
        run: |
          echo "# Nightly Benchmark Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date**: $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f reports/value_evidence/evidence.md ]; then
            cat reports/value_evidence/evidence.md >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f reports/bench/${{ github.sha }}/bench_full.md ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
            cat reports/bench/${{ github.sha }}/bench_full.md >> $GITHUB_STEP_SUMMARY
          fi
